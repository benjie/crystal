graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:3px,color:#000
    classDef itemplan fill:#fff,stroke-width:6px,color:#000
    classDef sideeffectplan fill:#f00,stroke-width:6px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:6px,text-align:left


    %% define plans
    __Value0["__Value[0∈0]"]:::plan
    __Value3["__Value[3∈0]<br />ᐸcontextᐳ"]:::plan
    Access30["Access[30∈0]<br />ᐸ3.pgSettingsᐳ"]:::plan
    Access31["Access[31∈0]<br />ᐸ3.withPgClientᐳ"]:::plan
    Object32["Object[32∈0]<br />ᐸ{pgSettings,withPgClient}ᐳ"]:::plan
    Connection33["Connection[33∈0]<br />ᐸ29ᐳ"]:::plan
    PgSelect34[["PgSelect[34∈0]<br />ᐸbadly_behaved_functionᐳ"]]:::plan
    __ListTransform35["__ListTransform[35∈0]<br />ᐸeach:34ᐳ"]:::plan
    __Item36>"__Item[36∈1]<br />ᐸ34ᐳ"]:::itemplan
    PgSelectSingle37["PgSelectSingle[37∈1]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    __Item38>"__Item[38∈2]<br />ᐸ35ᐳ"]:::itemplan
    PgSelectSingle39["PgSelectSingle[39∈2]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    Constant40["Constant[40∈0]"]:::plan
    PgClassExpression41["PgClassExpression[41∈2]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List42["List[42∈2]<br />ᐸ40,41ᐳ"]:::plan
    Lambda43["Lambda[43∈2]<br />ᐸencodeᐳ"]:::plan
    PgClassExpression46["PgClassExpression[46∈2]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan
    __ListTransform48["__ListTransform[48∈0]<br />ᐸeach:47ᐳ"]:::plan
    __Item49>"__Item[49∈3]<br />ᐸ34ᐳ"]:::itemplan
    PgSelectSingle50["PgSelectSingle[50∈3]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    __Item51>"__Item[51∈4]<br />ᐸ48ᐳ"]:::itemplan
    PgSelectSingle52["PgSelectSingle[52∈4]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    PgClassExpression55["PgClassExpression[55∈4]<br />ᐸrow_number...tion by 1)ᐳ"]:::plan
    List56["List[56∈4]<br />ᐸ55ᐳ"]:::plan
    PgCursor54["PgCursor[54∈4]"]:::plan
    Edge53["Edge[53∈4]"]:::plan
    Constant57["Constant[57∈0]"]:::plan
    PgClassExpression58["PgClassExpression[58∈4]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List59["List[59∈4]<br />ᐸ57,58ᐳ"]:::plan
    Lambda60["Lambda[60∈4]<br />ᐸencodeᐳ"]:::plan
    PgClassExpression63["PgClassExpression[63∈4]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan

    %% plan dependencies
    __Value3 --> Access30
    __Value3 --> Access31
    Access30 & Access31 --> Object32
    Object32 & Connection33 --> PgSelect34
    PgSelect34 --> __ListTransform35
    PgSelectSingle37 -.-> __ListTransform35
    PgSelect34 -.-> __Item36
    __Item36 --> PgSelectSingle37
    __ListTransform35 ==> __Item38
    __Item38 --> PgSelectSingle39
    PgSelectSingle39 --> PgClassExpression41
    Constant40 & PgClassExpression41 --> List42
    List42 --> Lambda43
    PgSelectSingle39 --> PgClassExpression46
    PgSelect34 --> __ListTransform48
    PgSelectSingle50 -.-> __ListTransform48
    PgSelect34 -.-> __Item49
    __Item49 --> PgSelectSingle50
    __ListTransform48 ==> __Item51
    __Item51 --> PgSelectSingle52
    PgSelectSingle52 --> PgClassExpression55
    PgClassExpression55 --> List56
    List56 --> PgCursor54
    PgSelectSingle52 & PgCursor54 --> Edge53
    PgSelectSingle52 --> PgClassExpression58
    Constant57 & PgClassExpression58 --> List59
    List59 --> Lambda60
    PgSelectSingle52 --> PgClassExpression63

    %% plan-to-path relationships
    P0["~"]
    __Value0 -.-> P0
    P33["ᐳbadlyBehavedFunction"]
    Connection33 -.-> P33
    P35["ᐳb…nᐳnodes"]
    __ListTransform35 -.-> P35
    P37["ᐳb…nᐳnodes@35[]"]
    PgSelectSingle37 -.-> P37
    P39["ᐳb…nᐳnodes[]"]
    PgSelectSingle39 -.-> P39
    P41["ᐳb…nᐳn…]ᐳid"]
    PgClassExpression41 -.-> P41
    P43["ᐳb…nᐳn…]ᐳnodeId"]
    Lambda43 -.-> P43
    P46["ᐳb…nᐳn…]ᐳfirstName"]
    PgClassExpression46 -.-> P46
    P48["ᐳb…nᐳedges"]
    __ListTransform48 -.-> P48
    P50["ᐳb…nᐳedges@48[]"]
    PgSelectSingle50 -.-> P50
    P52["ᐳb…nᐳe…]ᐳnode"]
    PgSelectSingle52 -.-> P52
    P53["ᐳb…nᐳedges[]"]
    Edge53 -.-> P53
    P54["ᐳb…nᐳe…]ᐳcursor"]
    PgCursor54 -.-> P54
    P58["ᐳb…nᐳe…]ᐳnodeᐳid"]
    PgClassExpression58 -.-> P58
    P60["ᐳb…nᐳe…]ᐳnodeᐳnodeId"]
    Lambda60 -.-> P60
    P63["ᐳb…nᐳe…]ᐳnodeᐳfirstName"]
    PgClassExpression63 -.-> P63

    subgraph "Buckets for queries/v4/badlyBehavedFunction"
    Bucket0("Bucket 0 (root)<br />~<br />⠀ROOT ᐸ-O- 0<br />⠀⠀badlyBehavedFunction ᐸ-O- 33<br />⠀⠀⠀badlyBehavedFunction.nodes ᐸ-A- 35<br />⠀⠀⠀badlyBehavedFunction.edges ᐸ-A- 48"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value0,__Value3,Access30,Access31,Object32,Connection33,PgSelect34,__ListTransform35,Constant40,__ListTransform48,Constant57 bucket0
    Bucket1("Bucket 1 (item36)<br />Deps: 34"):::bucket
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item36,PgSelectSingle37 bucket1
    Bucket2("Bucket 2 (item38)<br />Deps: 35, 40<br />~ᐳQuery.badlyBehavedFunctionᐳPeopleConnection.nodes[]<br />⠀ROOT ᐸ-O- 39<br />⠀⠀id ᐸ-L- 41<br />⠀⠀nodeId ᐸ-L- 43<br />⠀⠀firstName ᐸ-L- 46"):::bucket
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item38,PgSelectSingle39,PgClassExpression41,List42,Lambda43,PgClassExpression46 bucket2
    Bucket3("Bucket 3 (item49)<br />Deps: 34"):::bucket
    classDef bucket3 stroke:#ffa500
    class Bucket3,__Item49,PgSelectSingle50 bucket3
    Bucket4("Bucket 4 (item51)<br />Deps: 48, 57<br />~ᐳQuery.badlyBehavedFunctionᐳPeopleConnection.edges[]<br />⠀ROOT ᐸ-O- 53<br />⠀⠀node ᐸ-O- 52<br />⠀⠀⠀node.id ᐸ-L- 58<br />⠀⠀⠀node.nodeId ᐸ-L- 60<br />⠀⠀⠀node.firstName ᐸ-L- 63<br />⠀⠀cursor ᐸ-L- 54"):::bucket
    classDef bucket4 stroke:#0000ff
    class Bucket4,__Item51,PgSelectSingle52,Edge53,PgCursor54,PgClassExpression55,List56,PgClassExpression58,List59,Lambda60,PgClassExpression63 bucket4
    Bucket0 --> Bucket1 & Bucket2 & Bucket3 & Bucket4
    end
