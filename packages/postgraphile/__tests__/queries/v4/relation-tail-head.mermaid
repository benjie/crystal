graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:3px,color:#000
    classDef itemplan fill:#fff,stroke-width:6px,color:#000
    classDef sideeffectplan fill:#f00,stroke-width:6px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:6px,text-align:left


    %% define plans
    __Value0["__Value[0∈0]"]:::plan
    __Value3["__Value[3∈0]<br />ᐸcontextᐳ"]:::plan
    Access20["Access[20∈0]<br />ᐸ3.pgSettingsᐳ"]:::plan
    Access21["Access[21∈0]<br />ᐸ3.withPgClientᐳ"]:::plan
    Object22["Object[22∈0]<br />ᐸ{pgSettings,withPgClient}ᐳ"]:::plan
    Connection23["Connection[23∈0]<br />ᐸ19ᐳ"]:::plan
    PgSelect24[["PgSelect[24∈0]<br />ᐸcompoundKeyᐳ"]]:::plan
    __Item25>"__Item[25∈1]<br />ᐸ24ᐳ"]:::itemplan
    PgSelectSingle26["PgSelectSingle[26∈1]<br />ᐸcompoundKeyᐳ"]:::plan
    PgClassExpression27["PgClassExpression[27∈1]<br />ᐸ__compound...rson_id_1”ᐳ"]:::plan
    PgClassExpression28["PgClassExpression[28∈1]<br />ᐸ__compound...rson_id_2”ᐳ"]:::plan
    PgClassExpression29["PgClassExpression[29∈1]<br />ᐸ__compound...__.”extra”ᐳ"]:::plan
    Map93["Map[93∈1]<br />ᐸ26:{”0”:0,”1”:1}ᐳ"]:::plan
    PgSelectSingle36["PgSelectSingle[36∈1]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression37["PgClassExpression[37∈1]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression38["PgClassExpression[38∈1]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Map95["Map[95∈1]<br />ᐸ26:{”0”:3,”1”:4}ᐳ"]:::plan
    PgSelectSingle45["PgSelectSingle[45∈1]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression46["PgClassExpression[46∈1]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression47["PgClassExpression[47∈1]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Connection66["Connection[66∈0]<br />ᐸ62ᐳ"]:::plan
    PgSelect67[["PgSelect[67∈0]<br />ᐸforeignKeyᐳ"]]:::plan
    __Item68>"__Item[68∈2]<br />ᐸ67ᐳ"]:::itemplan
    PgSelectSingle69["PgSelectSingle[69∈2]<br />ᐸforeignKeyᐳ"]:::plan
    PgClassExpression70["PgClassExpression[70∈2]<br />ᐸ__foreign_...person_id”ᐳ"]:::plan
    PgClassExpression71["PgClassExpression[71∈2]<br />ᐸ__foreign_...und_key_1”ᐳ"]:::plan
    PgClassExpression72["PgClassExpression[72∈2]<br />ᐸ__foreign_...und_key_2”ᐳ"]:::plan
    Map97["Map[97∈2]<br />ᐸ69:{”0”:0,”1”:1}ᐳ"]:::plan
    PgSelectSingle79["PgSelectSingle[79∈2]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression80["PgClassExpression[80∈2]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression81["PgClassExpression[81∈2]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Map99["Map[99∈2]<br />ᐸ69:{”0”:3,”1”:4,”2”:5}ᐳ"]:::plan
    PgSelectSingle89["PgSelectSingle[89∈2]<br />ᐸcompoundKeyᐳ"]:::plan
    PgClassExpression90["PgClassExpression[90∈2]<br />ᐸ__compound...rson_id_1”ᐳ"]:::plan
    PgClassExpression91["PgClassExpression[91∈2]<br />ᐸ__compound...rson_id_2”ᐳ"]:::plan
    PgClassExpression92["PgClassExpression[92∈2]<br />ᐸ__compound...__.”extra”ᐳ"]:::plan

    %% plan dependencies
    __Value3 --> Access20
    __Value3 --> Access21
    Access20 & Access21 --> Object22
    Object22 & Connection23 --> PgSelect24
    PgSelect24 ==> __Item25
    __Item25 --> PgSelectSingle26
    PgSelectSingle26 --> PgClassExpression27
    PgSelectSingle26 --> PgClassExpression28
    PgSelectSingle26 --> PgClassExpression29
    PgSelectSingle26 --> Map93
    Map93 --> PgSelectSingle36
    PgSelectSingle36 --> PgClassExpression37
    PgSelectSingle36 --> PgClassExpression38
    PgSelectSingle26 --> Map95
    Map95 --> PgSelectSingle45
    PgSelectSingle45 --> PgClassExpression46
    PgSelectSingle45 --> PgClassExpression47
    Object22 & Connection66 --> PgSelect67
    PgSelect67 ==> __Item68
    __Item68 --> PgSelectSingle69
    PgSelectSingle69 --> PgClassExpression70
    PgSelectSingle69 --> PgClassExpression71
    PgSelectSingle69 --> PgClassExpression72
    PgSelectSingle69 --> Map97
    Map97 --> PgSelectSingle79
    PgSelectSingle79 --> PgClassExpression80
    PgSelectSingle79 --> PgClassExpression81
    PgSelectSingle69 --> Map99
    Map99 --> PgSelectSingle89
    PgSelectSingle89 --> PgClassExpression90
    PgSelectSingle89 --> PgClassExpression91
    PgSelectSingle89 --> PgClassExpression92

    %% plan-to-path relationships
    P0["~"]
    __Value0 -.-> P0
    P23["ᐳallCompoundKeys"]
    Connection23 -.-> P23
    P24["ᐳa…sᐳnodes"]
    PgSelect24 -.-> P24
    P26["ᐳa…sᐳnodes[]"]
    PgSelectSingle26 -.-> P26
    P27["ᐳa…sᐳn…]ᐳpersonId1"]
    PgClassExpression27 -.-> P27
    P28["ᐳa…sᐳn…]ᐳpersonId2"]
    PgClassExpression28 -.-> P28
    P29["ᐳa…sᐳn…]ᐳextra"]
    PgClassExpression29 -.-> P29
    P36["ᐳa…sᐳn…]ᐳpersonByPersonId1"]
    PgSelectSingle36 -.-> P36
    P37["ᐳa…sᐳn…]ᐳp…1ᐳname"]
    PgClassExpression37 -.-> P37
    P38["ᐳa…sᐳn…]ᐳp…1ᐳemail"]
    PgClassExpression38 -.-> P38
    P45["ᐳa…sᐳn…]ᐳpersonByPersonId2"]
    PgSelectSingle45 -.-> P45
    P46["ᐳa…sᐳn…]ᐳp…2ᐳname"]
    PgClassExpression46 -.-> P46
    P47["ᐳa…sᐳn…]ᐳp…2ᐳemail"]
    PgClassExpression47 -.-> P47
    P66["ᐳallForeignKeys"]
    Connection66 -.-> P66
    P67["ᐳa…sᐳnodes"]
    PgSelect67 -.-> P67
    P69["ᐳa…sᐳnodes[]"]
    PgSelectSingle69 -.-> P69
    P70["ᐳa…sᐳn…]ᐳpersonId"]
    PgClassExpression70 -.-> P70
    P71["ᐳa…sᐳn…]ᐳcompoundKey1"]
    PgClassExpression71 -.-> P71
    P72["ᐳa…sᐳn…]ᐳcompoundKey2"]
    PgClassExpression72 -.-> P72
    P79["ᐳa…sᐳn…]ᐳpersonByPersonId"]
    PgSelectSingle79 -.-> P79
    P80["ᐳa…sᐳn…]ᐳp…dᐳname"]
    PgClassExpression80 -.-> P80
    P81["ᐳa…sᐳn…]ᐳp…dᐳemail"]
    PgClassExpression81 -.-> P81
    P89["ᐳa…sᐳn…]ᐳcompoundKeyByCompoundKey1AndCompoundKey2"]
    PgSelectSingle89 -.-> P89
    P90["ᐳa…sᐳn…]ᐳc…2ᐳpersonId1"]
    PgClassExpression90 -.-> P90
    P91["ᐳa…sᐳn…]ᐳc…2ᐳpersonId2"]
    PgClassExpression91 -.-> P91
    P92["ᐳa…sᐳn…]ᐳc…2ᐳextra"]
    PgClassExpression92 -.-> P92

    subgraph "Buckets for queries/v4/relation-tail-head"
    Bucket0("Bucket 0 (root)<br />~<br />⠀ROOT ᐸ-O- 0<br />⠀⠀allCompoundKeys ᐸ-O- 23<br />⠀⠀⠀allCompoundKeys.nodes ᐸ-A- 24<br />⠀⠀allForeignKeys ᐸ-O- 66<br />⠀⠀⠀allForeignKeys.nodes ᐸ-A- 67"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value0,__Value3,Access20,Access21,Object22,Connection23,PgSelect24,Connection66,PgSelect67 bucket0
    Bucket1("Bucket 1 (item25)<br />Deps: 24<br />~ᐳQuery.allCompoundKeysᐳCompoundKeysConnection.nodes[]<br />⠀ROOT ᐸ-O- 26<br />⠀⠀personId1 ᐸ-L- 27<br />⠀⠀personId2 ᐸ-L- 28<br />⠀⠀extra ᐸ-L- 29<br />⠀⠀personByPersonId1 ᐸ-O- 36<br />⠀⠀⠀personByPersonId1.name ᐸ-L- 37<br />⠀⠀⠀personByPersonId1.email ᐸ-L- 38<br />⠀⠀personByPersonId2 ᐸ-O- 45<br />⠀⠀⠀personByPersonId2.name ᐸ-L- 46<br />⠀⠀⠀personByPersonId2.email ᐸ-L- 47"):::bucket
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item25,PgSelectSingle26,PgClassExpression27,PgClassExpression28,PgClassExpression29,PgSelectSingle36,PgClassExpression37,PgClassExpression38,PgSelectSingle45,PgClassExpression46,PgClassExpression47,Map93,Map95 bucket1
    Bucket2("Bucket 2 (item68)<br />Deps: 67<br />~ᐳQuery.allForeignKeysᐳForeignKeysConnection.nodes[]<br />⠀ROOT ᐸ-O- 69<br />⠀⠀personId ᐸ-L- 70<br />⠀⠀compoundKey1 ᐸ-L- 71<br />⠀⠀compoundKey2 ᐸ-L- 72<br />⠀⠀personByPersonId ᐸ-O- 79<br />⠀⠀⠀personByPersonId.name ᐸ-L- 80<br />⠀⠀⠀personByPersonId.email ᐸ-L- 81<br />⠀⠀compoundKeyByCompoundKey1AndCompoundKey2 ᐸ-O- 89<br />⠀⠀⠀compoundKeyByCompoundKey1AndCompoundKey2.personId1 ᐸ-L- 90<br />⠀⠀⠀compoundKeyByCompoundKey1AndCompoundKey2.personId2 ᐸ-L- 91<br />⠀⠀⠀compoundKeyByCompoundKey1AndCompoundKey2.extra ᐸ-L- 92"):::bucket
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item68,PgSelectSingle69,PgClassExpression70,PgClassExpression71,PgClassExpression72,PgSelectSingle79,PgClassExpression80,PgClassExpression81,PgSelectSingle89,PgClassExpression90,PgClassExpression91,PgClassExpression92,Map97,Map99 bucket2
    Bucket0 --> Bucket1 & Bucket2
    end
